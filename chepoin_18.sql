SELECT t1.ARS_PROTOCOLO AS "PROTOCOLO", t1.NAT_DESCRICAO AS "NATUREZA", t3.ars_descposicao AS "Status Atual", t1.ARS_RECEPCAO AS "DATA RECEPÇÃO", t1.ARG_DTPREVREG AS "LIMITE ANÁLISE", CASE WHEN t1.ARG_DTREGISTRO IS NOT NULL THEN 'FINALIZADO' WHEN (SELECT MAX(DAT_DTBAIXA) FROM arcari_02saojosecampos.datas WHERE ARS_PROTOCOLO = t1.ARS_PROTOCOLO AND OCO_CODIGO = 6) <= t1.ARG_DTPREVREG THEN 'DENTRO DO PRAZO' WHEN t4.ultima_reentrada IS NOT NULL THEN CASE WHEN (DATEDIFF(CURRENT_DATE, t4.ultima_reentrada) - (FLOOR(DATEDIFF(CURRENT_DATE, t4.ultima_reentrada) / 7) * 2)) > 5 THEN 'ATRASADO / CRÍTICO (REINGRESSO)' ELSE 'REINGRESSADO-DENTRO DO PRAZO' END WHEN t5.data_solicit IS NOT NULL AND t2.data_pagto IS NULL THEN 'AGUARDANDO DEPÓSITO' WHEN t2.data_pagto IS NOT NULL THEN CASE WHEN (DATEDIFF(CURRENT_DATE, t2.data_pagto) - (FLOOR(DATEDIFF(CURRENT_DATE, t2.data_pagto) / 7) * 2)) > 5 THEN 'ATRASADO / CRÍTICO (PÓS-PAGTO)' ELSE 'REINGRESSADO-DENTRO DO PRAZO' END WHEN CURRENT_DATE > t1.ARG_DTPREVREG AND t1.ARG_DTREGISTRO IS NULL THEN 'ATRASADO / CRÍTICO' ELSE 'DENTRO DO PRAZO' END AS "STATUS_GESTAO", CASE WHEN (SELECT MAX(DAT_DTBAIXA) FROM arcari_02saojosecampos.datas WHERE ARS_PROTOCOLO = t1.ARS_PROTOCOLO AND OCO_CODIGO = 6) <= t1.ARG_DTPREVREG THEN 'OK' WHEN ((t4.ultima_reentrada IS NOT NULL AND (DATEDIFF(CURRENT_DATE, t4.ultima_reentrada) - (FLOOR(DATEDIFF(CURRENT_DATE, t4.ultima_reentrada) / 7) * 2)) > 5) OR (t2.data_pagto IS NOT NULL AND (DATEDIFF(CURRENT_DATE, t2.data_pagto) - (FLOOR(DATEDIFF(CURRENT_DATE, t2.data_pagto) / 7) * 2)) > 5) OR (CURRENT_DATE > t1.ARG_DTPREVREG AND t1.ARG_DTREGISTRO IS NULL)) THEN 'MONITORAR' ELSE 'OK' END AS "MONITORAMENTO", (DATEDIFF(CURRENT_DATE, t2.data_pagto) - (FLOOR(DATEDIFF(CURRENT_DATE, t2.data_pagto) / 7) * 2)) AS "Tempo Depósito (Dias Úteis)", t4.ultima_reentrada AS "DATA_REENTRADA", t5.data_solicit AS "DT_SOLICIT_DEP", t2.data_pagto AS "DT_PAGTO_DEP", (SELECT MAX(DAT_DTBAIXA) FROM arcari_02saojosecampos.datas WHERE ARS_PROTOCOLO = t1.ARS_PROTOCOLO AND OCO_CODIGO = 6) AS "DT_ULTIMA_IRREGULAR", t1.ARG_DTVENCIMENTO AS "DATA VENCIMENTO", CASE WHEN CURRENT_DATE > t1.ARG_DTVENCIMENTO THEN 'VENCIDO' ELSE 'VIGENTE' END AS "PRENOTACAO", CASE WHEN t1.ARG_PEDIDO_ARISP IS NOT NULL THEN 'ELETRONICO' ELSE 'FÍSICO/BALCÃO' END AS "ORIGEM", '' AS "OBSERVACAO" FROM arcari_02saojosecampos.arc_reg t1 LEFT JOIN arcari_02saojosecampos.arc_seq_reg t3 ON t1.ARS_PROTOCOLO = t3.ars_protocolo AND t3.ars_seq = (SELECT MAX(sq.ars_seq) FROM arcari_02saojosecampos.arc_seq_reg sq WHERE sq.ars_protocolo = t1.ARS_PROTOCOLO) LEFT JOIN (SELECT protocolo, MAX(data) as data_pagto FROM r2sjcwin.caixa WHERE historico = 'COMPLEMENTO DE DEPOSITO' GROUP BY protocolo) t2 ON t1.ARS_PROTOCOLO = t2.protocolo LEFT JOIN (SELECT protocolo, MAX(data) as data_solicit FROM r2sjcwin.solicitacao GROUP BY protocolo) t5 ON t1.ARS_PROTOCOLO = t5.protocolo LEFT JOIN (SELECT ARS_PROTOCOLO, MAX(DAT_DTBAIXA) AS ultima_reentrada FROM arcari_02saojosecampos.datas WHERE OCO_CODIGO = 14 GROUP BY ARS_PROTOCOLO) t4 ON t1.ARS_PROTOCOLO = t4.ARS_PROTOCOLO WHERE t1.ARS_RECEPCAO >= '2025-10-24' AND t1.ARG_DTREGISTRO IS NULL AND (t3.ars_descposicao NOT IN ('Prazo Prorrogado', 'Cancelado por requerimento', 'Cancelado') OR t3.ars_descposicao IS NULL) ORDER BY CASE WHEN "MONITORAMENTO" = 'MONITORAR' THEN 0 ELSE 1 END, t1.ARG_DTPREVREG ASC;